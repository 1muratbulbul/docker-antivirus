#!/bin/bash
files=$(shopt -s nullglob dotglob; echo /data/malware/queue/*)
if (( ${#files} ))
then
    printf "SensorMalware: Found files to process\n"
    for file in "/data/malware/queue"/* ; do
        filename=`basename "$file"`
        mv -f "$file" "/data/malware/scan/${filename}"
        
        printf "SensorMalware: Processing /data/malware/scan/${filename}\n"
        /usr/local/bin/detect_malware.sh > /data/malware/scan/info 2>&1
        
        if [ -e "/data/malware/scan/${filename}" ]
        then
            printf "  --> SensorMalware: File ok\n"
            mv -f "/data/malware/scan/${filename}" "/data/defender/finish/${filename}"
            printf "  --> SensorMalware: File moved to /data/defender/finish/${filename}\n"
            rm -rf /data/malware/scan/info

        elif [ -e "/data/defender/quarantine/${filename}" ]
        then
            printf "  --> SensorMalware: File quarantined \n"
            mv -f "/data/malware/scan/info" "/data/defender/report/${filename}.txt"
            printf "  --> SensorMalware: Scan report moved to /data/defender/report/${filename}.txt\n"
        fi
    done
    printf "SensorMalware: Done with processing\n"
fi
